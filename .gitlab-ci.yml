stages:
  - build
  - test
  - deploy

build:
  stage: build
  script:
    - make lock
    - nix build
  artifacts:
    paths:
      - result

sanity test:
  stage: test
  script:
    - export ISQ_ROOT=`pwd`/result
    - export MLIR_ROOT=`pwd`/result
    - result/bin/isqc run examples/bell.isq

frontend test:
  stage: test
  script:
    - cd frontend
    - nix develop -c make configure build test

integration test:
  stage: test
  script:
    - export ISQ_ROOT=`pwd`/result
    - export MLIR_ROOT=`pwd`/result
    - cd isqc
    - nix develop -c cargo test
  dependencies:
    - build
    - sanity test
    - frontend test

# Create new "release/${MAJOR}.${MINOR}.x" branch for minor version.
# Invoked when pushing to main.
bump major or minor version:
  stage: deploy
  rules:
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH) && ($CI_PIPELINE_SOURCE == "push")
      changes:
        paths:
          - 'version.json'
  script:
    - nix develop -c ./scripts/ci/init_git.sh
    - nix develop -c ./scripts/ci/release_branch.sh

# Create new tag "v${MAJOR}.${MINOR}.${PATCH}" for version.
# Invoked when pushing to release branch.
bump patch version:
  stage: deploy
  rules:
    - if: ($CI_COMMIT_BRANCH =~ /^release.*/) && ($CI_PIPELINE_SOURCE == "push")
      changes:
        paths:
          - 'version.json'
  script:
    - nix develop -c ./scripts/ci/init_git.sh
    - nix develop -c ./scripts/ci/bump_tag.sh

deploy main branch doc:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - nix develop -c ./scripts/ci/init_git.sh
    - cd docs
    - git fetch origin gh-pages --depth=1
    - nix develop -c mike deploy --rebase latest
    - git push origin gh-pages
  
# Deploy a tagged version. Upload.
deploy tagged version:
  stage: deploy
  rules:
    - if: $CI_COMMIT_TAG
  script:
    # Upload tarball
    - nix build

    # Upload docs
    - nix develop -c ./scripts/ci/init_git.sh
    - cd docs
    - git fetch origin gh-pages --depth=1
    - nix develop -c mike deploy --rebase $CI_COMMIT_TAG
    - git push origin gh-pages
  release:
    name: '$'